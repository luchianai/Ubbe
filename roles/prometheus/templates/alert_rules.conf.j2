# Copyright 2024 Clivern
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

groups:
- name: ansible managed alert rules
  rules:
  - alert: Monitoring Heartbeat
    expr: count(up) > 0
    for: 0m
    labels:
      severity: info
    annotations:
      summary: "{% raw %}Monitoring system is healthy{% endraw %}"
      description: "{% raw %}Monitoring system is actively scraping {{ $value }} targets successfully.{% endraw %}"

  - alert: Monitoring targets missing
    expr: absent(up)
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "{% raw %}Monitoring targets missing for {{ $labels.job }}{% endraw %}"
      description: "{% raw %}No targets are being scraped for job {{ $labels.job }}. This indicates a monitoring system failure.{% endraw %}"

  - alert: Service is down
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "{% raw %}Instance {{ $labels.instance }} down{% endraw %}"
      description: "{% raw %}{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute.{% endraw %}"

  - alert: High CPU Usage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}High CPU usage on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}CPU usage is above 80% for 5 minutes{% endraw %}"

  - alert: High Memory Usage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}High memory usage on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}Memory usage is above 85% for 5 minutes{% endraw %}"

  - alert: Disk Space Filling
    expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}Disk space filling up on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}Disk usage is above 80% for 5 minutes{% endraw %}"

  - alert: Prometheus target scrape failures
    expr: increase(prometheus_target_scrape_pool_targets_failed_total[5m]) > 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}Prometheus target scrape failures on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}Prometheus is experiencing target scrape failures. Check target availability and network connectivity.{% endraw %}"

  - alert: Prometheus high memory usage
    expr: (process_resident_memory_bytes / 1024 / 1024) > 1024
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}Prometheus high memory usage on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}Prometheus is using more than 1GB of memory. Consider tuning retention or adding more memory.{% endraw %}"

  - alert: Node Exporter metrics stale
    expr: time() - node_boot_time_seconds > 86400
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "{% raw %}Node Exporter metrics may be stale on {{ $labels.instance }}{% endraw %}"
      description: "{% raw %}Node Exporter metrics haven't been updated recently. Check if the service is running properly.{% endraw %}"
